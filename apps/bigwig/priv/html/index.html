<html>
  <head>
    <title>So Peter... what's happening?</title>
    <link rel="stylesheet" type="text/css" href="/static/css/body.css" />
  </head>
  <body>
    <div id="header">
      <h1>BigWig</h1>
      <div id="attrib">brought to you by <a title="Fork on github" href="https://github.com/spawnfest/beamspirit">Smells Like BEAM Spirit</a></div>
    </div>
    <div id="side">
      <ul id="app" class="section">
        <li class="app _tpl"><a href="" class="permalink">
          <span class="name"></span>
          <span class="version"></span> 
          <p class="description"></p>
        </a></li>
      </ul>

      <div id="nodestats">
        <!-- realtime stats -->
        <strong>Node Stats</strong>
        <table id="stats">
            <tr>    
                <td>Date</td> 
                <td class="date"></td>    
            </tr>
            <tr>
                <td>Processes</td>
                <td class="process_count"></td>
            </tr>   
            <tr>
                <td>Reductions</td>
                <td class="reductions"></td>
            </tr>
            <tr>
                <td>Bytes In</td>
                <td class="bytes_in"></td>
            </tr>
            <tr>
                <td>Bytes Out</td>
                <td class="bytes_out"></td>
            </tr>
            <tr>
                <td>Run Queue</td>
                <td class="run_queue"></td>
            </tr>
            <tr>
                <td>Uptime</td>
                <td class="uptime"></td>
            </tr>
        </table>
        <span id="sl_reds"></span>
      </div>

    </div>
    <div id="main">
      <ul class="menu">
        <li><a class="filter current" href="/rb">all</a></li>
        <li><a class="filter" href="/rb?level=error">error</a></li>
        <li><a class="filter" href="/rb?level=info">info</a></li>
      </ul>
      <ul id="report" class="section all" data-sort="desc" data-filter="all">
        <li class="report _tpl">
          <span class="report_level"></span>
          <span class="group_leader"></span>
          <span class="pid"></span>
          <span class="report_type"></span>
          <span class="date"></span>

          <div class="application_start">
            <span class="label">Application start:</span>
            <span class="application"></span>
            <span class="started_at"></span>
          </div>

          <div class="started">
            <span class="label">Started:</span>
            <span class="started_pid"></span> 
            <span class="started_name"></span> 
          </div>
          
          <div class="info">
            <pre class="data"></pre>
          </div>
        </li>
      </ul>
    </div>

    <script type="text/javascript" src="/static/js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.sparkline.min.js"></script>
    <script type="text/javascript" src="/static/js/tpl.js"></script>
    <script type="text/javascript" src="/static/js/rb.js"></script>

    <script type="text/javascript">
        var MAX_POINTS = 30;
        var stats_data = {};
        <!-- connect to realtime stats feed -->
        $('#stats').bind('onupdate', function(e, data) {
                // generate sparklines for most of these stats:
                for(var key in data)
                {
                    if( key == 'date' )   continue;
                    if( key == 'uptime' ) continue;
                    if(! stats_data[key]) stats_data[key]=[];

                    stats_data[key].push(data[key]);
                    stats_data[key] = stats_data[key].slice( - (MAX_POINTS+1) );
                    // generate array of deltas to make sparkline:
                    var sparkdata = [];
                    var prevdata = stats_data[key][0];
                    for(var i = 1; i<stats_data[key].length; ++i)
                    {
                        thisdata = stats_data[key][i];
                        sparkdata.push( thisdata - prevdata );
                        prevdata = thisdata;
                    }
                    // console.log(key, ' data= ' , sparkdata)
                    $('.' + key).sparkline( sparkdata );
                }
                console.log("stats", data);
                });
        TPL.connect("/stats-stream");
    </script>

    <script type="text/javascript">
      // pull in apps list (ws for now, should be a TPL.fetch instead)
      // TPL.fetch("/apps");
      TPL.connect("/wh/ws");
    </script>
  </body>
</html>
